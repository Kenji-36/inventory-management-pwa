# カメラアクセスエラーのトラブルシューティング

## 🚨 問題: カメラ権限を許可したのにアクセスできない

### 症状
- ブラウザでカメラを「許可」に設定している
- それでも「カメラにアクセスできません」と表示される
- コンソールに `NotAllowedError: Permission denied` が表示される
- コンソールに `Permissions policy violation: camera is not allowed in this document` が表示される

## 🔧 解決方法（順番に試してください）

### 方法0: Chromeで直接アクセス（最重要）⭐

**iframe内ではカメラは絶対に動作しません。**

1. **Chromeブラウザを新しいタブで開く**
   - Cursorの内蔵ブラウザではなく、デスクトップのChromeアプリを起動

2. **アドレスバーに直接入力:**
   ```
   http://localhost:3000
   ```

3. **在庫管理画面に移動してスキャンを試す**

**確認方法:**
- コンソールログに `forward-logs-shared.ts` が表示される → Cursor内蔵ブラウザ（NG）
- 通常のChromeのログのみ → 正しく直接アクセスしている（OK）

---

### 方法1: ブラウザのキャッシュをクリア

1. **Ctrl+Shift+Delete** を押す

2. **以下にチェック:**
   - ✅ Cookie と他のサイトデータ
   - ✅ キャッシュされた画像とファイル
   - ✅ サイトの設定

3. **期間を「全期間」に設定**

4. **「データを削除」をクリック**

5. **ブラウザを完全に終了**
   - 全てのウィンドウを閉じる
   - タスクマネージャーでChromeが完全に終了しているか確認

6. **ブラウザを再起動**

7. **http://localhost:3000/inventory にアクセス**

8. **バーコードスキャンボタンをクリック**

9. **カメラ許可のポップアップが表示されたら「許可」をクリック**

---

### 方法2: カメラ設定を完全にリセット

#### Chrome設定から削除

1. **新しいタブを開く**

2. **アドレスバーに以下を入力してEnter:**
   ```
   chrome://settings/content/camera
   ```

3. **「許可」セクションから `localhost:3000` を削除**
   - 右側の「︙」→「削除」

4. **「ブロック」セクションからも `localhost:3000` を削除**（あれば）

5. **ブラウザを完全に再起動**

6. **http://localhost:3000/inventory にアクセス**

7. **バーコードスキャンボタンをクリック**

8. **新しく表示されるポップアップで「許可」をクリック**

---

### 方法3: 別のブラウザで試す

Chromeで解決しない場合、別のブラウザで試してください：

#### Microsoft Edge
1. Edgeを開く
2. http://localhost:3000/inventory にアクセス
3. バーコードスキャンをクリック
4. カメラ許可を求められたら「許可」をクリック

#### Firefox
1. Firefoxを開く
2. http://localhost:3000/inventory にアクセス
3. バーコードスキャンをクリック
4. カメラ許可を求められたら「許可」をクリック
5. **「決定を記憶する」にチェック**

---

### 方法4: シークレットモードで試す

1. **Ctrl+Shift+N** でシークレットウィンドウを開く

2. **http://localhost:3000/inventory にアクセス**

3. **バーコードスキャンボタンをクリック**

4. **カメラ許可を求められたら「許可」をクリック**

**シークレットモードで動作する場合:**
→ 通常モードの設定またはキャッシュに問題があります
→ 方法1（キャッシュクリア）を実行してください

---

### 方法5: 他のアプリがカメラを使用していないか確認

#### Windows

1. **Ctrl+Shift+Esc** でタスクマネージャーを開く

2. **以下のアプリが動いていないか確認:**
   - Zoom
   - Microsoft Teams
   - Skype
   - Discord
   - OBS Studio
   - その他のビデオ会議アプリ

3. **動いていたら右クリック → 「タスクの終了」**

4. **ブラウザをリロード**

---

### 方法6: Windowsのプライバシー設定を確認

1. **Windowsの設定を開く**

2. **「プライバシーとセキュリティ」をクリック**

3. **「カメラ」をクリック**

4. **以下がオンになっているか確認:**
   - ✅ カメラへのアクセス
   - ✅ アプリがカメラにアクセスできるようにする
   - ✅ デスクトップアプリがカメラにアクセスできるようにする

5. **設定を変更した場合、PCを再起動**

---

### 方法7: カメラドライバーの確認

1. **デバイスマネージャーを開く**
   - Windowsキー + X → デバイスマネージャー

2. **「カメラ」または「イメージングデバイス」を展開**

3. **カメラに「!」マークがないか確認**

4. **問題がある場合:**
   - 右クリック → 「ドライバーの更新」
   - または右クリック → 「デバイスのアンインストール」→ PCを再起動（自動再インストール）

---

## 🧪 カメラが正常に動作するかテスト

別のサイトでカメラをテスト:

1. **新しいタブを開く**

2. **https://webcamtests.com/ にアクセス**

3. **「Test my cam」をクリック**

4. **カメラ許可を求められたら「許可」をクリック**

5. **カメラの映像が表示されればOK**

**このテストサイトでもカメラが動作しない場合:**
→ ブラウザやOSの設定に問題があります
→ 方法5、6、7を試してください

---

## 🔍 詳細なデバッグ方法

### コンソールログを確認

1. **F12キーを押して開発者ツールを開く**

2. **Consoleタブを確認**

3. **以下のログを探す:**
   ```
   🎥 カメラ初期化開始...
   ❌ Scanner error: NotAllowedError: Permission denied
   Error details: { name: "NotAllowedError", message: "Permission denied", ... }
   ```

4. **エラーの `name` と `message` をメモ**

### よくあるエラーと原因

| エラー名 | 原因 | 解決方法 |
|---------|------|---------|
| Permissions policy violation | iframe内でアクセスしている | **方法0（Chrome直接アクセス）** |
| NotAllowedError | 権限が拒否されている | 方法0、1または2 |
| NotFoundError | カメラが見つからない | カメラの接続を確認 |
| NotReadableError | カメラが使用中 | 他のアプリを終了 |
| SecurityError | HTTPSまたはlocalhostでない | URLを確認 |

---

## 💡 最も確実な解決方法（推奨）

以下の手順を**順番に全て**実行してください：

1. **Chromeブラウザを直接開く**
   - Cursor内蔵ブラウザではなく、デスクトップのChromeアプリを起動

2. **全てのビデオ会議アプリを終了**（Zoom、Teamsなど）

3. **ブラウザのキャッシュをクリア**（Ctrl+Shift+Delete）

4. **ブラウザを完全に終了**（タスクマネージャーで確認）

5. **PCを再起動**（推奨）

6. **Chromeブラウザを起動**

7. **アドレスバーに直接入力: http://localhost:3000**

8. **在庫管理画面に移動してバーコードスキャンをクリック**

9. **カメラ許可のポップアップで「許可」をクリック**

---

## 📞 それでも解決しない場合

以下の情報を確認してください：

1. **ブラウザ名とバージョン**
   - Chrome: アドレスバーに `chrome://version` と入力

2. **OS（Windows 10 / 11）**

3. **カメラの種類**
   - 内蔵カメラ / 外付けUSBカメラ

4. **コンソールのエラーメッセージ**（全文）

5. **webcamtests.com でのテスト結果**

6. **シークレットモードでの動作結果**

---

## 🎯 代替手段

カメラがどうしても動作しない場合、以下の代替手段があります：

### 手動でJANコードを入力

1. 商品一覧で検索ボックスにJANコードを入力
2. 該当商品が表示される
3. 「追加」ボタンをクリック

### スマートフォンのカメラを使用

1. スマートフォンで http://[PCのIPアドレス]:3000/inventory にアクセス
2. バーコードスキャンを使用
3. ※ ただし、IPアドレスでのアクセスではカメラが動作しない場合があります

---

## 🔧 開発者向け情報

### 実装済みの対策

このアプリケーションでは、以下の対策が実装されています：

1. **iframe検出機能**
   - `window.self !== window.top` でiframe内かどうかを判定
   - iframe内の場合は専用メッセージを表示し、カメラ初期化を試みない

2. **Permissions-Policy設定**
   - `next.config.ts` で `camera=(self)` を設定
   - 同一オリジンでのカメラアクセスを許可

3. **ユーザー操作後の初期化**
   - ボタンクリック後に `html5-qrcode` を動的ロード（`require()`）
   - 自動起動を防止し、ブラウザのセキュリティポリシーに準拠

4. **Service Worker対策**
   - POST/PUT/DELETEリクエストのキャッシュを無効化
   - GET以外のリクエストは Service Worker をスキップ

### トラブルシューティングのポイント

- **Cursor内蔵ブラウザ**: iframe扱いのため、カメラは動作しない
- **直接Chrome**: 正常に動作する
- **コンソールログ**: `forward-logs-shared.ts` が見えたらiframe内

---

## 🔐 セキュリティに関する注意

- カメラ映像はブラウザ内でのみ処理されます
- サーバーには送信されません
- バーコード認識はローカル（デバイス内）で実行されます
- 撮影された画像は保存されません

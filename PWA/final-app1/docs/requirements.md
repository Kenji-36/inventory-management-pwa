# 在庫注文管理システム 要件定義書

## 目次
1. [システム概要](#1-システム概要)
2. [機能要件](#2-機能要件)
3. [データベース設計](#3-データベース設計)
4. [技術要件](#4-技術要件)
5. [画面設計](#5-画面設計)
6. [開発ステップ](#6-開発ステップ)

---

## 1. システム概要

### 1.1 目的
- 商品の在庫管理、売上管理を一元化
- バーコードスキャンによる効率的な在庫管理の実現
- 売上データの可視化による経営判断の支援

### 1.2 システム構成
| 項目 | 内容 |
|------|------|
| アプリケーション形態 | PWA（Progressive Web Application） |
| データベース | `db/template_DB.xlsx` → Google Spreadsheet連携 |
| 認証方式 | Googleアカウントによるログイン |
| デザイン | レスポンシブデザイン（マルチデバイス対応） |

### 1.3 対象ユーザー
| ユーザー種別 | 権限 |
|-------------|------|
| 管理者 | 全機能へのアクセス、ユーザー管理 |
| 一般ユーザー | 在庫管理、売上管理機能の利用 |

---

## 2. 機能要件

### 2.1 認証・認可機能

#### 2.1.1 ログイン機能
- Googleアカウントによるシングルサインオン（SSO）
- ログイン状態の保持（セッション管理）
- ログアウト機能

#### 2.1.2 権限管理
- ユーザー権限の設定（管理者/一般ユーザー）
- 権限に応じた機能制限

---

### 2.2 在庫管理機能（SKU管理）

#### 2.2.1 商品一覧表示
- **入れ子構造表示**: 同一「商品コード」を持つ商品は親子構造で表示
  ```
  ポロシャツ (MLS-101)          [合計在庫: 5]
  ├─ ポロシャツ S (JAN: 4595643591894)  在庫: 2
  └─ ポロシャツ M (JAN: 4595643591900)  在庫: 3

  カジュアルTシャツ (MCT-202)   [合計在庫: 9]
  ├─ カジュアルTシャツ S (JAN: 4595643591917)  在庫: 4
  └─ カジュアルTシャツ M (JAN: 4595643591924)  在庫: 5

  デニムジャケット (MDJ-303)    [合計在庫: 11]
  ├─ デニムジャケット S (JAN: 4595643591931)  在庫: 6
  └─ デニムジャケット M (JAN: 4595643591948)  在庫: 5
  ```
- ページネーション対応
- ソート機能（商品名、在庫数、更新日時）

#### 2.2.2 商品検索機能
| 検索項目 | 説明 |
|----------|------|
| 商品名 | 部分一致検索 |
| 商品コード | 完全一致/部分一致検索 |
| JANコード | 完全一致検索 |

#### 2.2.3 在庫数量更新
- 手動での在庫数量変更
- 変更履歴の記録
- **リアルタイムでスプレッドシートへ反映**

#### 2.2.4 バーコードスキャン（在庫追加）
- カメラを使用したJANコードスキャン
- スキャン後、該当商品の在庫数量を+1
- **スプレッドシートへの自動反映**

#### 2.2.5 CSV入出力機能
| 機能 | 説明 |
|------|------|
| CSVテンプレートダウンロード | 商品情報入力用のテンプレートファイル取得 |
| CSVアップロード | 商品情報の一括更新 |
| スプレッドシート同期 | アップロード後、自動でスプレッドシート更新 |

**CSVテンプレート仕様（商品情報）**:
```csv
商品ID,商品名,画像URL,サイズ,商品コード,JANコード,税抜価格,税込価格
1,ポロシャツ,,S,MLS-101,4595643591894,3500,3850
2,ポロシャツ,,M,MLS-101,4595643591900,3500,3850
```

| カラム | 必須 | 説明 |
|--------|------|------|
| 商品ID | ○ | 既存商品の更新時は必須、新規追加時は空欄 |
| 商品名 | ○ | 商品名称 |
| 画像URL | - | 商品画像URL（任意） |
| サイズ | ○ | S, M, L など |
| 商品コード | ○ | SKUコード（同一商品はコードを揃える） |
| JANコード | ○ | 13桁のJANコード |
| 税抜価格 | ○ | 数値（円） |
| 税込価格 | ○ | 数値（円） |

**CSV処理フロー**:
1. CSVファイルをアップロード
2. バリデーション（必須項目、データ型、JANコード桁数）
3. プレビュー表示（追加/更新件数の確認）
4. 確定ボタンでスプレッドシートへ反映
5. 在庫情報シートへの初期在庫追加（新規商品の場合）

---

### 2.3 売上管理機能（受注管理）

#### 2.3.1 注文一覧表示
- 全注文の一覧表示
- 注文番号クリックで詳細表示
- 注文ステータス表示

#### 2.3.2 注文詳細表示
- 注文番号、注文日時
- 注文商品一覧
- **税込金額・税抜金額の両方表示**
- 合計金額表示

#### 2.3.3 新規注文作成
| ステップ | 操作内容 |
|----------|----------|
| 1 | 新規注文を開始 |
| 2 | バーコードスキャンボタンをクリック |
| 3 | カメラでバーコードをスキャン |
| 4 | 商品が注文に追加される |
| 5 | 数量を「+」「-」ボタンで調整 |
| 6 | 合計金額を確認 |
| 7 | 「注文確認」ボタンで確定 |

#### 2.3.4 数量調整機能
- 「+」ボタン: 数量を1増加
- 「-」ボタン: 数量を1減少（最小値: 1）
- 商品削除機能

#### 2.3.5 注文確定処理
- 注文確定時、注文一覧に反映
- **スプレッドシートへ注文情報を追加**
- 在庫数量の自動減算

---

### 2.4 ダッシュボード機能

#### 2.4.1 売上推移グラフ
- 日別/週別/月別の売上推移
- 折れ線グラフまたは棒グラフ表示
- 期間選択機能

#### 2.4.2 注文数表示
- 本日の注文数
- 今週/今月の注文数
- 前期比較

#### 2.4.3 在庫情報サマリー
- 総商品数
- 在庫切れ商品数
- 在庫少商品のアラート表示

#### 2.4.4 商品別売上分析
- 売上上位商品ランキング
- カテゴリ別売上比率

---

## 3. データベース設計

### 3.1 データソース
- **ファイル**: `db/template_DB.xlsx`
- **連携先**: Google Spreadsheet（API経由）
- **シート数**: 5シート（商品、在庫情報、注文情報、注文詳細、ユーザマスタ）

### 3.2 シート構成（実データベース構造）

> ※ 以下は `template_DB.xlsx` の実際の構造に基づいています

#### 3.2.1 商品シート（商品）
| カラム名 | データ型 | 説明 | 例 |
|----------|----------|------|-----|
| 商品ID | NUMBER | 商品ID（一意・主キー） | 1, 2, 3... |
| 商品名 | STRING | 商品名称 | ポロシャツ, カジュアルTシャツ |
| 画像URL | STRING | 商品画像のURL | （空欄可） |
| サイズ | STRING | サイズ | S, M, L |
| 商品コード | STRING | SKU商品コード | MLS-101, MCT-202 |
| JANコード | STRING | JANコード（13桁） | 4595643591894 |
| 税抜価格 | NUMBER | 税抜価格（円） | 3500 |
| 税込価格 | NUMBER | 税込価格（円） | 3850 |
| 作成日 | DATETIME | レコード作成日時 | 2024-03-20 6:47:44 |
| 更新日 | DATETIME | レコード更新日時 | 2024-06-11 11:51:48 |

**サンプルデータ（30件）**:
| 商品ID | 商品名 | サイズ | 商品コード | JANコード | 税抜価格 | 税込価格 |
|--------|--------|--------|------------|-----------|----------|----------|
| 1 | ポロシャツ | S | MLS-101 | 4595643591894 | 3,500 | 3,850 |
| 2 | ポロシャツ | M | MLS-101 | 4595643591900 | 3,500 | 3,850 |
| 3 | カジュアルTシャツ | S | MCT-202 | 4595643591917 | 2,800 | 3,080 |
| 4 | カジュアルTシャツ | M | MCT-202 | 4595643591924 | 2,800 | 3,080 |
| 5 | デニムジャケット | S | MDJ-303 | 4595643591931 | 8,200 | 9,020 |
| ... | ... | ... | ... | ... | ... | ... |

**SKUグルーピングルール**:
- 同一の「商品コード」を持つ商品は同一商品の色・サイズ違いとして扱う
- 例: MLS-101 → ポロシャツ（S）, ポロシャツ（M）

---

#### 3.2.2 在庫情報シート（在庫情報）
| カラム名 | データ型 | 説明 | 例 |
|----------|----------|------|-----|
| 在庫ID | NUMBER | 在庫ID（一意・主キー） | 1, 2, 3... |
| 商品ID | NUMBER | 商品ID（外部キー→商品） | 1, 2, 3... |
| 在庫数 | NUMBER | 現在の在庫数量 | 2, 3, 4... |
| 最終入庫日 | DATE | 最後に入庫した日付 | 2024/08/13 |
| 作成日 | DATETIME | レコード作成日時 | 2024/04/15 6:41 |
| 更新日 | DATETIME | レコード更新日時 | 2024/06/11 21:44 |

**サンプルデータ（30件）**:
| 在庫ID | 商品ID | 在庫数 | 最終入庫日 |
|--------|--------|--------|------------|
| 1 | 1 | 2 | 2024/08/13 |
| 2 | 2 | 3 | 2024/08/13 |
| 3 | 3 | 4 | 2024/08/13 |
| ... | ... | ... | ... |

---

#### 3.2.3 注文情報シート（注文情報）
| カラム名 | データ型 | 説明 | 例 |
|----------|----------|------|-----|
| 注文ID | NUMBER | 注文ID（一意・主キー） | 1001, 1002... |
| 商品数 | NUMBER | 注文に含まれる商品点数 | 8 |
| 注文金額(税抜) | NUMBER | 合計金額（税抜） | 25,200 |
| 注文金額(税込) | NUMBER | 合計金額（税込） | 27,720 |
| 注文日 | DATETIME | 注文日時 | 2024/04/15 6:41 |

**サンプルデータ（5件）**:
| 注文ID | 商品数 | 注文金額(税抜) | 注文金額(税込) | 注文日 |
|--------|--------|----------------|----------------|--------|
| 1001 | 8 | ¥25,200 | ¥27,720 | 2024/04/15 |
| 1002 | 8 | ¥92,800 | ¥102,080 | 2024/04/16 |
| 1003 | 8 | ¥36,000 | ¥39,600 | 2024/04/17 |
| 1004 | 8 | ¥46,000 | ¥50,600 | 2024/04/18 |
| 1005 | 8 | ¥34,000 | ¥37,400 | 2024/04/19 |

---

#### 3.2.4 注文詳細シート（注文詳細）
| カラム名 | データ型 | 説明 | 例 |
|----------|----------|------|-----|
| 明細ID | NUMBER | 明細ID（一意・主キー） | 1001, 1002... |
| 注文ID | NUMBER | 注文ID（外部キー→注文情報） | 1001 |
| 商品ID | NUMBER | 商品ID（外部キー→商品） | 1, 2, 3... |
| 数量 | NUMBER | 注文数量 | 2 |
| 単価(税抜) | NUMBER | 商品単価（税抜） | 3,500 |
| 単価(税込) | NUMBER | 商品単価（税込） | 3,850 |
| 小計(税抜) | NUMBER | 小計金額（税抜） | 7,000 |
| 小計(税込) | NUMBER | 小計金額（税込） | 7,700 |
| 作成日 | DATETIME | レコード作成日時 | 2024/04/15 6:41 |
| 更新日 | DATETIME | レコード更新日時 | 2024/04/15 6:41 |

**サンプルデータ**:
| 明細ID | 注文ID | 商品ID | 数量 | 単価(税抜) | 単価(税込) | 小計(税抜) | 小計(税込) |
|--------|--------|--------|------|------------|------------|------------|------------|
| 1001 | 1001 | 1 | 2 | 3,500 | 3,850 | 7,000 | 7,700 |
| 1002 | 1001 | 2 | 2 | 3,500 | 3,850 | 7,000 | 7,700 |
| 1003 | 1001 | 3 | 2 | 2,800 | 3,080 | 5,600 | 6,160 |
| ... | ... | ... | ... | ... | ... | ... | ... |

---

### 3.3 ER図（エンティティ関連図）

```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│    商品     │       │  在庫情報   │       │ ユーザマスタ│
├─────────────┤       ├─────────────┤       ├─────────────┤
│ 商品ID (PK) │◄──────│ 商品ID (FK) │       │ idno (PK)   │
│ 商品名      │   1:1 │ 在庫ID (PK) │       │ user_id     │
│ 商品コード  │       │ 在庫数      │       │ email       │
│ JANコード   │       │ 最終入庫日  │       │ name        │
│ サイズ      │       └─────────────┘       │ role        │
│ 税抜価格    │                             └─────────────┘
│ 税込価格    │
└─────────────┘
       │
       │ 1:N
       ▼
┌─────────────┐       ┌─────────────┐
│  注文詳細   │       │  注文情報   │
├─────────────┤       ├─────────────┤
│ 明細ID (PK) │       │ 注文ID (PK) │
│ 注文ID (FK) │───────│ 商品数      │
│ 商品ID (FK) │  N:1  │ 注文金額    │
│ 数量        │       │ 注文日      │
│ 単価        │       └─────────────┘
│ 小計        │
└─────────────┘
```

#### 3.2.5 ユーザマスタシート（ユーザマスタ）
| カラム名 | データ型 | 説明 | 例 |
|----------|----------|------|-----|
| idno | NUMBER | ID番号（一意・主キー） | 1, 2, 3... |
| user_id | STRING | ユーザーID（メールアドレス） | saablow@yahoo.co.jp |
| email | STRING | メールアドレス | saablow@yahoo.co.jp |
| name | STRING | ユーザー名 | NANGOU |
| role | STRING | 権限（admin/user） | admin |
| created_at | DATETIME | 作成日時 | 2026/2/4 16:48 |
| updated_at | DATETIME | 更新日時 | 2026/2/4 16:48 |

**サンプルデータ**:
| idno | user_id | email | name | role |
|------|---------|-------|------|------|
| 1 | saablow@yahoo.co.jp | saablow@yahoo.co.jp | NANGOU | admin |

**権限種別**:
| role | 説明 |
|------|------|
| admin | 管理者：全機能へのアクセス、ユーザー管理 |
| user | 一般ユーザー：在庫管理、売上管理機能の利用 |

---

## 4. 技術要件

### 4.1 フロントエンド
| 項目 | 技術/ツール |
|------|-------------|
| フレームワーク | Next.js 14（App Router） |
| 言語 | TypeScript |
| スタイリング | Tailwind CSS |
| UIコンポーネント | shadcn/ui |
| バーコードスキャン | html5-qrcode / QuaggaJS |
| グラフ表示 | Chart.js / Recharts |
| 状態管理 | React Context / Zustand |

### 4.2 PWA対応
| 機能 | 説明 |
|------|------|
| Service Worker | オフライン対応、キャッシュ戦略 |
| Web App Manifest | インストール可能なアプリ設定 |
| Push通知 | 在庫アラート通知（オプション） |

### 4.3 バックエンド
| 項目 | 技術/ツール |
|------|-------------|
| API | Next.js API Routes |
| 認証 | NextAuth.js（Google Provider） |
| Spreadsheet連携 | Google Sheets API v4 |
| アーキテクチャ | サーバーレス |

### 4.4 インフラ
| 項目 | サービス |
|------|----------|
| ホスティング | Vercel |
| 認証基盤 | Google Cloud Platform |
| データベース | Google Spreadsheet |

### 4.5 開発ツール
| 項目 | ツール |
|------|--------|
| パッケージ管理 | npm / pnpm |
| コード品質 | ESLint, Prettier |
| バージョン管理 | Git |

---

## 5. 画面設計

### 5.1 画面一覧
| No | 画面名 | URL | 説明 |
|----|--------|-----|------|
| 1 | ログイン画面 | /login | Google認証画面 |
| 2 | ダッシュボード | / | メイン画面、売上グラフ等 |
| 3 | 在庫一覧 | /inventory | 商品一覧、検索、スキャン |
| 4 | 在庫詳細 | /inventory/[id] | 商品詳細、在庫更新 |
| 5 | 在庫スキャン | /inventory/scan | バーコードスキャン画面 |
| 6 | CSV管理 | /inventory/csv | CSV入出力画面 |
| 7 | 注文一覧 | /orders | 注文一覧表示 |
| 8 | 注文詳細 | /orders/[id] | 注文詳細表示 |
| 9 | 新規注文 | /orders/new | 新規注文作成 |
| 10 | 設定 | /settings | ユーザー設定 |

### 5.2 画面遷移図
```
[ログイン] → [ダッシュボード]
                ↓
    ┌──────────┼──────────┐
    ↓          ↓          ↓
[在庫管理]  [注文管理]  [設定]
    ↓          ↓
[スキャン]  [注文詳細]
[CSV管理]   [新規注文]
```

### 5.3 レイアウト構成
```
┌─────────────────────────────────────┐
│           ヘッダー                  │
│  ロゴ  メニュー  ユーザー情報       │
├─────────────────────────────────────┤
│                                     │
│                                     │
│           メインコンテンツ          │
│                                     │
│                                     │
├─────────────────────────────────────┤
│           フッター（PWA時は非表示） │
└─────────────────────────────────────┘
```

---

## 6. 開発ステップ

### ステップ1: 環境構築 ✅ 完了
- [x] Next.jsプロジェクトの作成
- [x] 必要パッケージのインストール
- [x] Tailwind CSS、shadcn/uiのセットアップ
- [x] 基本的なフォルダ構成の作成

### ステップ2: 認証機能の実装 ✅ 完了
- [x] Google Cloud Platformでプロジェクト作成（※環境変数設定が必要）
- [x] OAuth 2.0クライアントの設定（※環境変数設定が必要）
- [x] NextAuth.jsの設定
- [x] ログイン/ログアウト機能の実装

### ステップ3: Google Spreadsheet連携 ✅ 完了
- [x] Google Sheets APIの有効化（※設定ガイド参照）
- [x] サービスアカウントの作成（※設定ガイド参照）
- [x] Spreadsheetへの接続設定
- [x] CRUD操作のAPI作成

### ステップ4: 在庫管理機能の実装 ✅ 完了
- [x] 商品一覧画面の作成
- [x] SKU入れ子構造の実装
- [x] 検索機能の実装
- [x] 在庫数量更新機能
- [x] バーコードスキャン機能

### ステップ5: CSV入出力機能の実装 ✅ 完了
- [x] CSVテンプレートダウンロード機能
- [x] CSVアップロード・パース機能
- [x] Spreadsheet更新処理

### ステップ6: 売上管理機能の実装 ✅ 完了
- [x] 注文一覧画面の作成
- [x] 注文詳細画面の作成
- [x] 新規注文作成機能
- [x] バーコードスキャンによる商品追加
- [x] 数量調整機能
- [x] 注文確定・Spreadsheet登録

### ステップ7: ダッシュボードの実装 ✅ 完了
- [x] 売上推移グラフの作成
- [x] 注文数サマリーの表示
- [x] 在庫情報サマリーの表示
- [x] 商品別売上分析

### ステップ8: PWA対応 ✅ 完了
- [x] Web App Manifestの作成
- [x] Service Workerの実装
- [x] オフライン対応
- [x] アイコンの作成

### ステップ9: テスト・デプロイ
- [ ] 各機能のテスト
- [ ] Vercelへのデプロイ
- [ ] 本番環境での動作確認

---

## 補足事項

### セキュリティ考慮事項
- Google OAuth認証による安全なログイン
- API Routesでのサーバーサイド処理
- 環境変数による機密情報の管理
- CORS設定の適切な実装

### パフォーマンス考慮事項
- Spreadsheetデータのキャッシュ戦略
- 画像の最適化
- コードスプリッティング
- Service Workerによるキャッシュ

### 今後の拡張可能性
- 複数店舗対応
- 発注管理機能
- 棚卸し機能
- レポート出力機能（PDF）

---

## 付録

### 用語集
| 用語 | 説明 |
|------|------|
| SKU | Stock Keeping Unit（在庫管理単位） |
| JANコード | Japanese Article Number（商品識別コード） |
| PWA | Progressive Web Application |
| SSO | Single Sign-On（シングルサインオン） |

### 参考リンク
- [Next.js 公式ドキュメント](https://nextjs.org/docs)
- [Google Sheets API](https://developers.google.com/sheets/api)
- [NextAuth.js](https://next-auth.js.org/)
- [html5-qrcode](https://github.com/mebjas/html5-qrcode)

---

*作成日: 2026年2月4日*
*最終更新日: 2026年2月4日*
*バージョン: 1.2*

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0 | 2026/02/04 | 初版作成 |
| 1.1 | 2026/02/04 | template_DB.xlsx の実データ構造に基づきDB設計を更新、CSV仕様追加 |
| 1.2 | 2026/02/04 | ユーザマスタシートを追加、ER図更新 |

# Google OAuth 2.0 設定ガイド（初学者向け）

このガイドでは、Google Cloud Console で OAuth 2.0 クライアントIDを作成し、
アプリケーションでGoogleログインを有効にする方法を説明します。

---

## 目次
1. [Google Cloud Console にアクセス](#1-google-cloud-console-にアクセス)
2. [新しいプロジェクトを作成](#2-新しいプロジェクトを作成)
3. [OAuth 同意画面を設定](#3-oauth-同意画面を設定)
4. [OAuth 2.0 クライアントIDを作成](#4-oauth-20-クライアントidを作成)
5. [環境変数を設定](#5-環境変数を設定)
6. [動作確認](#6-動作確認)

---

## 1. Google Cloud Console にアクセス

### 手順

1. ブラウザで以下のURLにアクセスします：
   
   👉 **https://console.cloud.google.com/**

2. Googleアカウントでログインします
   - 既にログインしている場合はそのまま進みます
   - アカウントがない場合は新規作成してください

3. 初めての場合、利用規約への同意を求められます
   - 「同意する」をクリックして進みます

---

## 2. 新しいプロジェクトを作成

### 手順

1. 画面上部の **プロジェクトを選択** をクリック

   ![プロジェクト選択](画像の説明：画面上部左側にある「プロジェクトを選択」というドロップダウン)

2. 表示されるダイアログで **「新しいプロジェクト」** をクリック

3. プロジェクト情報を入力：
   
   | 項目 | 入力値 |
   |------|--------|
   | プロジェクト名 | `inventory-management`（任意の名前） |
   | 場所 | そのまま（組織なしでOK） |

4. **「作成」** ボタンをクリック

5. 作成完了まで数秒待ちます

6. 作成されたプロジェクトを選択します
   - 画面上部のプロジェクト選択から、作成したプロジェクトを選んでください

---

## 3. OAuth 同意画面を設定

OAuth同意画面は、ユーザーがログインする際に表示される画面の設定です。

### 手順

1. 左側のメニューから **「APIとサービス」** → **「OAuth 同意画面」** をクリック

   > 💡 メニューが見つからない場合は、左上の「≡」（ハンバーガーメニュー）をクリックしてください

2. **User Type** を選択：
   
   | 選択肢 | 説明 |
   |--------|------|
   | **外部** | ✅ これを選択（Googleアカウントを持つ全員が利用可能） |
   | 内部 | Google Workspace組織内のみ（有料アカウント向け） |

3. **「作成」** をクリック

4. **アプリ情報** を入力：

   | 項目 | 入力値 | 必須 |
   |------|--------|------|
   | アプリ名 | `在庫注文管理システム` | ✅ |
   | ユーザーサポートメール | あなたのメールアドレスを選択 | ✅ |
   | アプリのロゴ | 省略可能 | - |

5. **アプリのドメイン** （省略可能）：
   - 開発段階ではすべて空欄でOK

6. **デベロッパーの連絡先情報**：
   
   | 項目 | 入力値 |
   |------|--------|
   | メールアドレス | あなたのメールアドレス |

7. **「保存して次へ」** をクリック

8. **スコープ** 画面：
   - 何も追加せず **「保存して次へ」** をクリック

9. **テストユーザー** 画面：
   - **「+ ADD USERS」** をクリック
   - あなたのGoogleメールアドレスを入力
   - **「追加」** をクリック
   - **「保存して次へ」** をクリック

   > ⚠️ **重要**: テストモードでは、ここに追加したユーザーのみがログインできます

10. **概要** 画面で内容を確認し、**「ダッシュボードに戻る」** をクリック

---

## 4. OAuth 2.0 クライアントIDを作成

### 手順

1. 左側のメニューから **「APIとサービス」** → **「認証情報」** をクリック

2. 画面上部の **「+ 認証情報を作成」** をクリック

3. **「OAuth クライアント ID」** を選択

4. **アプリケーションの種類** を選択：
   
   👉 **「ウェブ アプリケーション」** を選択

5. **クライアントID情報** を入力：

   | 項目 | 入力値 |
   |------|--------|
   | 名前 | `inventory-web-client`（任意） |

6. **承認済みの JavaScript 生成元** ：
   
   **「+ URI を追加」** をクリックして以下を入力：
   ```
   http://localhost:3000
   ```

7. **承認済みのリダイレクト URI** ：
   
   **「+ URI を追加」** をクリックして以下を入力：
   ```
   http://localhost:3000/api/auth/callback/google
   ```

   > 🔴 **非常に重要**: このURLは正確に入力してください。1文字でも間違えると認証が失敗します。

8. **「作成」** をクリック

9. **クライアントIDが作成されました！** というダイアログが表示されます：

   ```
   クライアント ID:     xxxxxxxxxx.apps.googleusercontent.com
   クライアント シークレット: xxxxxxxxxxxxxxxxxxxxxxxx
   ```

   > 🔴 **この情報を必ずコピーして保存してください！**
   > - 「JSONをダウンロード」をクリックしてバックアップを取ることをお勧めします

10. **「OK」** をクリック

---

## 5. 環境変数を設定

取得したクライアントIDとシークレットをアプリケーションに設定します。

### 手順

1. プロジェクトフォルダ（`final-app1`）に `.env.local` ファイルを作成

2. 以下の内容を記述：

```env
# Google OAuth認証用（↓ 取得した値に置き換えてください）
GOOGLE_CLIENT_ID=xxxxxxxxxx.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=xxxxxxxxxxxxxxxxxxxxxxxx

# NextAuth.js用
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-key-here

# アプリケーション設定
NODE_ENV=development
```

### NEXTAUTH_SECRET の生成方法

ターミナルで以下のコマンドを実行して、ランダムな秘密鍵を生成します：

**Windows (PowerShell):**
```powershell
[Convert]::ToBase64String([System.Security.Cryptography.RandomNumberGenerator]::GetBytes(32))
```

**または、以下の文字列を使用：**
```
openssl rand -base64 32
```
（Node.jsがインストールされている場合）

生成された文字列を `NEXTAUTH_SECRET` に設定してください。

---

## 6. 動作確認

### 手順

1. 開発サーバーを起動：
   ```bash
   npm run dev
   ```

2. ブラウザで http://localhost:3000 にアクセス

3. ログインページが表示されたら、**「Googleでログイン」** をクリック

4. Googleアカウント選択画面が表示されます
   - テストユーザーとして登録したアカウントを選択

5. 同意画面が表示されたら **「続行」** をクリック

6. ログイン成功！ダッシュボードが表示されます 🎉

---

## トラブルシューティング

### エラー: "redirect_uri_mismatch"

**原因**: リダイレクトURIが正しく設定されていない

**解決方法**:
1. Google Cloud Console → 認証情報 → 作成したOAuthクライアントをクリック
2. 「承認済みのリダイレクト URI」が以下と完全に一致しているか確認：
   ```
   http://localhost:3000/api/auth/callback/google
   ```

### エラー: "Access blocked: This app's request is invalid"

**原因**: OAuth同意画面の設定が不完全

**解決方法**:
1. OAuth同意画面で必須項目がすべて入力されているか確認
2. テストユーザーにログインしようとしているアカウントが追加されているか確認

### エラー: "アクセスがブロックされました"

**原因**: テストユーザーに登録されていないアカウントでログインしようとしている

**解決方法**:
1. OAuth同意画面 → テストユーザー → ログインしたいメールアドレスを追加

### 本番環境へのデプロイ時

本番環境（Vercel等）にデプロイする場合：

1. **承認済みの JavaScript 生成元** に本番URLを追加：
   ```
   https://your-app.vercel.app
   ```

2. **承認済みのリダイレクト URI** に本番URLを追加：
   ```
   https://your-app.vercel.app/api/auth/callback/google
   ```

3. 環境変数 `NEXTAUTH_URL` を本番URLに更新

---

## 参考リンク

- [Google Cloud Console](https://console.cloud.google.com/)
- [NextAuth.js Google Provider](https://next-auth.js.org/providers/google)
- [OAuth 2.0 の仕組み](https://developers.google.com/identity/protocols/oauth2)

---

*作成日: 2026年2月4日*

# ブログ記事執筆支援Webアプリケーション データベース設計書

## 1. ドキュメント情報

**文書バージョン**: 1.0  
**作成日**: 2025年12月1日  
**最終更新日**: 2025年12月1日  
**関連ドキュメント**: システム設計書.md、API設計書.md  
**データベース**: PostgreSQL 16.x

---

## 2. データベース概要

### 2.1 実装フェーズ

#### MVP段階（Phase 1）
- **ストレージ**: ブラウザのLocalStorage
- **データ形式**: JSON
- **永続化**: クライアントサイドのみ

#### 将来実装（Phase 2以降）
- **RDBMS**: PostgreSQL 16.x
- **キャッシュ**: Redis 7.x
- **ファイルストレージ**: AWS S3 / Cloudflare R2（画像等）

### 2.2 設計方針

1. **正規化**: 第3正規形を基本とする
2. **パフォーマンス**: 適切なインデックス設計
3. **スケーラビリティ**: パーティショニング対応
4. **監査**: 作成日時・更新日時を全テーブルに
5. **論理削除**: 重要データは物理削除しない

---

## 3. ER図

### 3.1 全体ER図

```
┌─────────────────┐
│     users       │
│─────────────────│
│ id (PK)         │
│ email (UNIQUE)  │
│ name            │
│ password_hash   │
│ email_verified  │
│ plan            │
│ created_at      │
│ updated_at      │
│ deleted_at      │
└─────────────────┘
        │
        │ 1:N
        ▼
┌─────────────────┐
│    projects     │
│─────────────────│
│ id (PK)         │
│ user_id (FK)    │
│ title           │
│ status          │
│ theme           │
│ selected_headline│
│ current_step    │
│ data (JSONB)    │
│ word_count      │
│ created_at      │
│ updated_at      │
│ deleted_at      │
└─────────────────┘
        │
        │ 1:N
        ├─────────────────────┐
        │                     │
        ▼                     ▼
┌─────────────────┐   ┌─────────────────┐
│   headlines     │   │    outlines     │
│─────────────────│   │─────────────────│
│ id (PK)         │   │ id (PK)         │
│ project_id (FK) │   │ project_id (FK) │
│ text            │   │ level           │
│ description     │   │ text            │
│ is_selected     │   │ order           │
│ generation_count│   │ parent_id       │
│ created_at      │   │ word_count_est  │
└─────────────────┘   │ created_at      │
                      │ updated_at      │
                      └─────────────────┘
                              │
                              │ 1:1
                              ▼
                      ┌─────────────────┐
                      │    contents     │
                      │─────────────────│
                      │ id (PK)         │
                      │ outline_id (FK) │
                      │ text            │
                      │ word_count      │
                      │ status          │
                      │ generation_count│
                      │ created_at      │
                      │ updated_at      │
                      └─────────────────┘

┌─────────────────┐
│  generations    │
│─────────────────│
│ id (PK)         │
│ project_id (FK) │
│ user_id (FK)    │
│ type            │
│ input           │
│ output          │
│ model           │
│ tokens_input    │
│ tokens_output   │
│ cost            │
│ duration_ms     │
│ status          │
│ error_message   │
│ created_at      │
└─────────────────┘

┌─────────────────┐
│  api_keys       │
│─────────────────│
│ id (PK)         │
│ user_id (FK)    │
│ provider        │
│ key_encrypted   │
│ is_active       │
│ created_at      │
│ updated_at      │
└─────────────────┘

┌─────────────────┐
│  usage_logs     │
│─────────────────│
│ id (PK)         │
│ user_id (FK)    │
│ action          │
│ resource_type   │
│ resource_id     │
│ metadata (JSONB)│
│ created_at      │
└─────────────────┘
```

---

## 4. テーブル定義

### 4.1 usersテーブル

**説明**: ユーザー情報を管理

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | ユーザーID（主キー） |
| email | VARCHAR(255) | NOT NULL | - | メールアドレス（一意） |
| name | VARCHAR(255) | NULL | - | ユーザー名 |
| password_hash | VARCHAR(255) | NOT NULL | - | パスワードハッシュ |
| email_verified | BOOLEAN | NOT NULL | false | メール認証済みフラグ |
| plan | VARCHAR(50) | NOT NULL | 'free' | プラン（free/pro/enterprise） |
| avatar_url | TEXT | NULL | - | アバター画像URL |
| preferences | JSONB | NULL | '{}' | ユーザー設定 |
| created_at | TIMESTAMPTZ | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |
| deleted_at | TIMESTAMPTZ | NULL | - | 削除日時（論理削除） |

**インデックス**:
```sql
CREATE UNIQUE INDEX idx_users_email ON users(email) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_plan ON users(plan);
CREATE INDEX idx_users_created_at ON users(created_at);
```

**制約**:
```sql
ALTER TABLE users ADD CONSTRAINT chk_users_plan 
  CHECK (plan IN ('free', 'pro', 'enterprise'));
ALTER TABLE users ADD CONSTRAINT chk_users_email_format 
  CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$');
```

**DDL**:
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) NOT NULL,
  name VARCHAR(255),
  password_hash VARCHAR(255) NOT NULL,
  email_verified BOOLEAN NOT NULL DEFAULT false,
  plan VARCHAR(50) NOT NULL DEFAULT 'free',
  avatar_url TEXT,
  preferences JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMPTZ,
  
  CONSTRAINT chk_users_plan CHECK (plan IN ('free', 'pro', 'enterprise')),
  CONSTRAINT chk_users_email_format CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
);

CREATE UNIQUE INDEX idx_users_email ON users(email) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_plan ON users(plan);
CREATE INDEX idx_users_created_at ON users(created_at);
```

---

### 4.2 projectsテーブル

**説明**: ブログ記事プロジェクトを管理

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | プロジェクトID（主キー） |
| user_id | UUID | NOT NULL | - | ユーザーID（外部キー） |
| title | VARCHAR(500) | NOT NULL | - | プロジェクトタイトル |
| status | VARCHAR(50) | NOT NULL | 'draft' | ステータス |
| theme | TEXT | NOT NULL | - | 記事のテーマ |
| selected_headline | TEXT | NULL | - | 選択された見出し |
| current_step | INTEGER | NOT NULL | 1 | 現在のステップ（1-5） |
| data | JSONB | NOT NULL | '{}' | プロジェクトデータ（JSON） |
| word_count | INTEGER | NOT NULL | 0 | 総文字数 |
| tags | TEXT[] | NULL | - | タグ配列 |
| is_favorite | BOOLEAN | NOT NULL | false | お気に入りフラグ |
| created_at | TIMESTAMPTZ | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |
| completed_at | TIMESTAMPTZ | NULL | - | 完了日時 |
| deleted_at | TIMESTAMPTZ | NULL | - | 削除日時（論理削除） |

**インデックス**:
```sql
CREATE INDEX idx_projects_user_id ON projects(user_id);
CREATE INDEX idx_projects_status ON projects(status);
CREATE INDEX idx_projects_created_at ON projects(created_at DESC);
CREATE INDEX idx_projects_user_status ON projects(user_id, status);
CREATE INDEX idx_projects_tags ON projects USING GIN(tags);
```

**制約**:
```sql
ALTER TABLE projects ADD CONSTRAINT fk_projects_user_id 
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE projects ADD CONSTRAINT chk_projects_status 
  CHECK (status IN ('draft', 'in_progress', 'completed', 'archived'));
ALTER TABLE projects ADD CONSTRAINT chk_projects_current_step 
  CHECK (current_step BETWEEN 1 AND 5);
```

**DDL**:
```sql
CREATE TABLE projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  title VARCHAR(500) NOT NULL,
  status VARCHAR(50) NOT NULL DEFAULT 'draft',
  theme TEXT NOT NULL,
  selected_headline TEXT,
  current_step INTEGER NOT NULL DEFAULT 1,
  data JSONB NOT NULL DEFAULT '{}',
  word_count INTEGER NOT NULL DEFAULT 0,
  tags TEXT[],
  is_favorite BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  completed_at TIMESTAMPTZ,
  deleted_at TIMESTAMPTZ,
  
  CONSTRAINT fk_projects_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  CONSTRAINT chk_projects_status CHECK (status IN ('draft', 'in_progress', 'completed', 'archived')),
  CONSTRAINT chk_projects_current_step CHECK (current_step BETWEEN 1 AND 5)
);

CREATE INDEX idx_projects_user_id ON projects(user_id);
CREATE INDEX idx_projects_status ON projects(status);
CREATE INDEX idx_projects_created_at ON projects(created_at DESC);
CREATE INDEX idx_projects_user_status ON projects(user_id, status);
CREATE INDEX idx_projects_tags ON projects USING GIN(tags);
```

---

### 4.3 headlinesテーブル

**説明**: 生成された見出し候補を管理

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 見出しID（主キー） |
| project_id | UUID | NOT NULL | - | プロジェクトID（外部キー） |
| text | TEXT | NOT NULL | - | 見出しテキスト |
| description | TEXT | NULL | - | 見出しの説明 |
| is_selected | BOOLEAN | NOT NULL | false | 選択フラグ |
| generation_count | INTEGER | NOT NULL | 1 | 何回目の生成か |
| estimated_word_count | INTEGER | NULL | - | 推定文字数 |
| created_at | TIMESTAMPTZ | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |

**インデックス**:
```sql
CREATE INDEX idx_headlines_project_id ON headlines(project_id);
CREATE INDEX idx_headlines_is_selected ON headlines(project_id, is_selected);
```

**制約**:
```sql
ALTER TABLE headlines ADD CONSTRAINT fk_headlines_project_id 
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE;
```

**DDL**:
```sql
CREATE TABLE headlines (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL,
  text TEXT NOT NULL,
  description TEXT,
  is_selected BOOLEAN NOT NULL DEFAULT false,
  generation_count INTEGER NOT NULL DEFAULT 1,
  estimated_word_count INTEGER,
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  
  CONSTRAINT fk_headlines_project_id FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
);

CREATE INDEX idx_headlines_project_id ON headlines(project_id);
CREATE INDEX idx_headlines_is_selected ON headlines(project_id, is_selected);
```

---

### 4.4 outlinesテーブル

**説明**: 記事の目次を管理

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 目次ID（主キー） |
| project_id | UUID | NOT NULL | - | プロジェクトID（外部キー） |
| level | INTEGER | NOT NULL | - | 見出しレベル（2 or 3） |
| text | TEXT | NOT NULL | - | 見出しテキスト |
| order_index | INTEGER | NOT NULL | - | 表示順序 |
| parent_id | UUID | NULL | - | 親の目次ID（H3の場合） |
| word_count_estimated | INTEGER | NULL | - | 推定文字数 |
| created_at | TIMESTAMPTZ | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |

**インデックス**:
```sql
CREATE INDEX idx_outlines_project_id ON outlines(project_id);
CREATE INDEX idx_outlines_parent_id ON outlines(parent_id);
CREATE INDEX idx_outlines_order ON outlines(project_id, order_index);
```

**制約**:
```sql
ALTER TABLE outlines ADD CONSTRAINT fk_outlines_project_id 
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE;
ALTER TABLE outlines ADD CONSTRAINT fk_outlines_parent_id 
  FOREIGN KEY (parent_id) REFERENCES outlines(id) ON DELETE CASCADE;
ALTER TABLE outlines ADD CONSTRAINT chk_outlines_level 
  CHECK (level IN (2, 3));
```

**DDL**:
```sql
CREATE TABLE outlines (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL,
  level INTEGER NOT NULL,
  text TEXT NOT NULL,
  order_index INTEGER NOT NULL,
  parent_id UUID,
  word_count_estimated INTEGER,
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  
  CONSTRAINT fk_outlines_project_id FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
  CONSTRAINT fk_outlines_parent_id FOREIGN KEY (parent_id) REFERENCES outlines(id) ON DELETE CASCADE,
  CONSTRAINT chk_outlines_level CHECK (level IN (2, 3))
);

CREATE INDEX idx_outlines_project_id ON outlines(project_id);
CREATE INDEX idx_outlines_parent_id ON outlines(parent_id);
CREATE INDEX idx_outlines_order ON outlines(project_id, order_index);
```

---

### 4.5 contentsテーブル

**説明**: セクションごとの本文を管理

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | コンテンツID（主キー） |
| outline_id | UUID | NOT NULL | - | 目次ID（外部キー） |
| text | TEXT | NOT NULL | - | 本文テキスト |
| word_count | INTEGER | NOT NULL | 0 | 文字数 |
| status | VARCHAR(50) | NOT NULL | 'pending' | ステータス |
| generation_count | INTEGER | NOT NULL | 0 | 生成回数 |
| created_at | TIMESTAMPTZ | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |
| generated_at | TIMESTAMPTZ | NULL | - | 生成完了日時 |

**インデックス**:
```sql
CREATE UNIQUE INDEX idx_contents_outline_id ON contents(outline_id);
CREATE INDEX idx_contents_status ON contents(status);
```

**制約**:
```sql
ALTER TABLE contents ADD CONSTRAINT fk_contents_outline_id 
  FOREIGN KEY (outline_id) REFERENCES outlines(id) ON DELETE CASCADE;
ALTER TABLE contents ADD CONSTRAINT chk_contents_status 
  CHECK (status IN ('pending', 'generating', 'completed', 'error'));
```

**DDL**:
```sql
CREATE TABLE contents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  outline_id UUID NOT NULL,
  text TEXT NOT NULL,
  word_count INTEGER NOT NULL DEFAULT 0,
  status VARCHAR(50) NOT NULL DEFAULT 'pending',
  generation_count INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  generated_at TIMESTAMPTZ,
  
  CONSTRAINT fk_contents_outline_id FOREIGN KEY (outline_id) REFERENCES outlines(id) ON DELETE CASCADE,
  CONSTRAINT chk_contents_status CHECK (status IN ('pending', 'generating', 'completed', 'error'))
);

CREATE UNIQUE INDEX idx_contents_outline_id ON contents(outline_id);
CREATE INDEX idx_contents_status ON contents(status);
```

---

### 4.6 generationsテーブル

**説明**: AI生成の履歴を管理（コスト管理・分析用）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 生成ID（主キー） |
| project_id | UUID | NOT NULL | - | プロジェクトID（外部キー） |
| user_id | UUID | NOT NULL | - | ユーザーID（外部キー） |
| type | VARCHAR(50) | NOT NULL | - | 生成タイプ |
| input | TEXT | NOT NULL | - | 入力プロンプト |
| output | TEXT | NULL | - | 出力結果 |
| model | VARCHAR(100) | NOT NULL | - | 使用モデル |
| tokens_input | INTEGER | NULL | - | 入力トークン数 |
| tokens_output | INTEGER | NULL | - | 出力トークン数 |
| cost | DECIMAL(10, 6) | NULL | - | コスト（USD） |
| duration_ms | INTEGER | NULL | - | 処理時間（ミリ秒） |
| status | VARCHAR(50) | NOT NULL | 'pending' | ステータス |
| error_message | TEXT | NULL | - | エラーメッセージ |
| created_at | TIMESTAMPTZ | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |

**インデックス**:
```sql
CREATE INDEX idx_generations_project_id ON generations(project_id);
CREATE INDEX idx_generations_user_id ON generations(user_id);
CREATE INDEX idx_generations_type ON generations(type);
CREATE INDEX idx_generations_created_at ON generations(created_at DESC);
CREATE INDEX idx_generations_user_created ON generations(user_id, created_at DESC);
```

**制約**:
```sql
ALTER TABLE generations ADD CONSTRAINT fk_generations_project_id 
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE;
ALTER TABLE generations ADD CONSTRAINT fk_generations_user_id 
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE generations ADD CONSTRAINT chk_generations_type 
  CHECK (type IN ('headline', 'outline', 'content', 'batch'));
ALTER TABLE generations ADD CONSTRAINT chk_generations_status 
  CHECK (status IN ('pending', 'processing', 'completed', 'failed'));
```

**DDL**:
```sql
CREATE TABLE generations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL,
  user_id UUID NOT NULL,
  type VARCHAR(50) NOT NULL,
  input TEXT NOT NULL,
  output TEXT,
  model VARCHAR(100) NOT NULL,
  tokens_input INTEGER,
  tokens_output INTEGER,
  cost DECIMAL(10, 6),
  duration_ms INTEGER,
  status VARCHAR(50) NOT NULL DEFAULT 'pending',
  error_message TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  
  CONSTRAINT fk_generations_project_id FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
  CONSTRAINT fk_generations_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  CONSTRAINT chk_generations_type CHECK (type IN ('headline', 'outline', 'content', 'batch')),
  CONSTRAINT chk_generations_status CHECK (status IN ('pending', 'processing', 'completed', 'failed'))
);

CREATE INDEX idx_generations_project_id ON generations(project_id);
CREATE INDEX idx_generations_user_id ON generations(user_id);
CREATE INDEX idx_generations_type ON generations(type);
CREATE INDEX idx_generations_created_at ON generations(created_at DESC);
CREATE INDEX idx_generations_user_created ON generations(user_id, created_at DESC);
```

---

### 4.7 api_keysテーブル

**説明**: ユーザーのAPIキーを管理（将来実装）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | APIキーID（主キー） |
| user_id | UUID | NOT NULL | - | ユーザーID（外部キー） |
| provider | VARCHAR(50) | NOT NULL | - | プロバイダー |
| key_encrypted | TEXT | NOT NULL | - | 暗号化されたAPIキー |
| is_active | BOOLEAN | NOT NULL | true | 有効フラグ |
| created_at | TIMESTAMPTZ | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |

**インデックス**:
```sql
CREATE INDEX idx_api_keys_user_id ON api_keys(user_id);
CREATE INDEX idx_api_keys_provider ON api_keys(user_id, provider);
```

**制約**:
```sql
ALTER TABLE api_keys ADD CONSTRAINT fk_api_keys_user_id 
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE api_keys ADD CONSTRAINT chk_api_keys_provider 
  CHECK (provider IN ('openai', 'anthropic'));
```

**DDL**:
```sql
CREATE TABLE api_keys (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  provider VARCHAR(50) NOT NULL,
  key_encrypted TEXT NOT NULL,
  is_active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  
  CONSTRAINT fk_api_keys_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  CONSTRAINT chk_api_keys_provider CHECK (provider IN ('openai', 'anthropic'))
);

CREATE INDEX idx_api_keys_user_id ON api_keys(user_id);
CREATE INDEX idx_api_keys_provider ON api_keys(user_id, provider);
```

---

### 4.8 usage_logsテーブル

**説明**: ユーザーの操作ログを記録

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | ログID（主キー） |
| user_id | UUID | NOT NULL | - | ユーザーID（外部キー） |
| action | VARCHAR(100) | NOT NULL | - | アクション |
| resource_type | VARCHAR(50) | NULL | - | リソースタイプ |
| resource_id | UUID | NULL | - | リソースID |
| metadata | JSONB | NULL | '{}' | メタデータ |
| ip_address | INET | NULL | - | IPアドレス |
| user_agent | TEXT | NULL | - | ユーザーエージェント |
| created_at | TIMESTAMPTZ | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |

**インデックス**:
```sql
CREATE INDEX idx_usage_logs_user_id ON usage_logs(user_id);
CREATE INDEX idx_usage_logs_action ON usage_logs(action);
CREATE INDEX idx_usage_logs_created_at ON usage_logs(created_at DESC);
CREATE INDEX idx_usage_logs_resource ON usage_logs(resource_type, resource_id);
```

**制約**:
```sql
ALTER TABLE usage_logs ADD CONSTRAINT fk_usage_logs_user_id 
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
```

**DDL**:
```sql
CREATE TABLE usage_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  action VARCHAR(100) NOT NULL,
  resource_type VARCHAR(50),
  resource_id UUID,
  metadata JSONB DEFAULT '{}',
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  
  CONSTRAINT fk_usage_logs_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE INDEX idx_usage_logs_user_id ON usage_logs(user_id);
CREATE INDEX idx_usage_logs_action ON usage_logs(action);
CREATE INDEX idx_usage_logs_created_at ON usage_logs(created_at DESC);
CREATE INDEX idx_usage_logs_resource ON usage_logs(resource_type, resource_id);
```

---

## 5. LocalStorage設計（MVP）

### 5.1 データ構造

```typescript
// LocalStorageキー
const STORAGE_KEYS = {
  CURRENT_PROJECT: 'blog-generator:current-project',
  SETTINGS: 'blog-generator:settings',
  CACHE: 'blog-generator:cache',
} as const;

// プロジェクトデータ
interface LocalStorageProject {
  id: string;
  version: string;
  createdAt: string;
  updatedAt: string;
  currentStep: number;
  
  theme: {
    text: string;
  };
  
  headlines: {
    candidates: Array<{
      id: string;
      text: string;
      description: string;
      generatedAt: string;
    }>;
    selected: {
      id: string;
      text: string;
      description: string;
    } | null;
    generationCount: number;
  };
  
  outline: {
    items: Array<{
      id: string;
      level: 2 | 3;
      text: string;
      order: number;
      parentId: string | null;
    }>;
    generationCount: number;
  };
  
  content: {
    sections: Array<{
      id: string;
      outlineItemId: string;
      text: string;
      status: 'pending' | 'generating' | 'completed' | 'error';
      generatedAt: string | null;
      generationCount: number;
      wordCount: number;
    }>;
    generationMode: 'sequential' | 'batch';
  };
  
  metadata: {
    totalGenerationTime: number;
    aiModel: string;
    wordCount: number;
  };
}

// 設定データ
interface LocalStorageSettings {
  aiProvider: 'openai' | 'anthropic';
  model: string;
  temperature: number;
  maxTokens: number;
  language: 'ja' | 'en';
  theme: 'light' | 'dark';
}
```

### 5.2 データ操作

```typescript
// 保存
function saveProject(project: LocalStorageProject): void {
  const compressed = LZString.compress(JSON.stringify(project));
  localStorage.setItem(STORAGE_KEYS.CURRENT_PROJECT, compressed);
}

// 読み込み
function loadProject(): LocalStorageProject | null {
  const compressed = localStorage.getItem(STORAGE_KEYS.CURRENT_PROJECT);
  if (!compressed) return null;
  
  const decompressed = LZString.decompress(compressed);
  if (!decompressed) return null;
  
  return JSON.parse(decompressed);
}

// 削除
function deleteProject(): void {
  localStorage.removeItem(STORAGE_KEYS.CURRENT_PROJECT);
}

// 容量チェック
function getStorageSize(): number {
  let total = 0;
  for (const key in localStorage) {
    if (localStorage.hasOwnProperty(key)) {
      total += localStorage[key].length + key.length;
    }
  }
  return total;
}
```

---

## 6. マイグレーション戦略

### 6.1 LocalStorage → PostgreSQL移行

```typescript
// 移行スクリプト例
async function migrateFromLocalStorage(userId: string) {
  // LocalStorageからデータ取得
  const localProject = loadProject();
  if (!localProject) return;
  
  // PostgreSQLに保存
  const project = await db.projects.create({
    data: {
      userId,
      title: localProject.headlines.selected?.text || 'Untitled',
      status: 'draft',
      theme: localProject.theme.text,
      selectedHeadline: localProject.headlines.selected?.text,
      currentStep: localProject.currentStep,
      data: localProject,
      wordCount: localProject.metadata.wordCount,
    },
  });
  
  // 見出し保存
  for (const headline of localProject.headlines.candidates) {
    await db.headlines.create({
      data: {
        projectId: project.id,
        text: headline.text,
        description: headline.description,
        isSelected: headline.id === localProject.headlines.selected?.id,
      },
    });
  }
  
  // 目次保存
  for (const outline of localProject.outline.items) {
    await db.outlines.create({
      data: {
        projectId: project.id,
        level: outline.level,
        text: outline.text,
        orderIndex: outline.order,
        parentId: outline.parentId,
      },
    });
  }
  
  // LocalStorageをクリア
  deleteProject();
  
  return project;
}
```

---

## 7. パフォーマンス最適化

### 7.1 インデックス戦略

**複合インデックス**:
```sql
-- ユーザーのプロジェクト一覧取得用
CREATE INDEX idx_projects_user_status_created 
  ON projects(user_id, status, created_at DESC);

-- 生成履歴の集計用
CREATE INDEX idx_generations_user_date 
  ON generations(user_id, created_at DESC);
```

**部分インデックス**:
```sql
-- アクティブなプロジェクトのみ
CREATE INDEX idx_projects_active 
  ON projects(user_id, updated_at DESC) 
  WHERE deleted_at IS NULL AND status != 'archived';

-- 完了したコンテンツのみ
CREATE INDEX idx_contents_completed 
  ON contents(outline_id) 
  WHERE status = 'completed';
```

### 7.2 パーティショニング

**日付ベースパーティショニング（generations, usage_logs）**:
```sql
-- generationsテーブルのパーティショニング
CREATE TABLE generations_2025_12 PARTITION OF generations
  FOR VALUES FROM ('2025-12-01') TO ('2026-01-01');

CREATE TABLE generations_2026_01 PARTITION OF generations
  FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');
```

### 7.3 クエリ最適化

**N+1問題の回避**:
```sql
-- プロジェクト一覧取得（見出し・目次も含む）
SELECT 
  p.*,
  json_agg(DISTINCT h.*) AS headlines,
  json_agg(DISTINCT o.*) AS outlines
FROM projects p
LEFT JOIN headlines h ON h.project_id = p.id
LEFT JOIN outlines o ON o.project_id = p.id
WHERE p.user_id = $1 AND p.deleted_at IS NULL
GROUP BY p.id
ORDER BY p.updated_at DESC
LIMIT 20;
```

---

## 8. バックアップ・リストア

### 8.1 バックアップ戦略

**自動バックアップ**:
- 頻度: 毎日深夜2時（UTC）
- 保持期間: 30日間
- 方式: フルバックアップ + WALアーカイブ

**バックアップコマンド**:
```bash
# フルバックアップ
pg_dump -U postgres -d blog_generator -F c -f backup_$(date +%Y%m%d).dump

# 特定テーブルのみ
pg_dump -U postgres -d blog_generator -t projects -t contents -F c -f backup_data.dump
```

### 8.2 リストア

```bash
# フルリストア
pg_restore -U postgres -d blog_generator -c backup_20251201.dump

# 特定テーブルのみ
pg_restore -U postgres -d blog_generator -t projects backup_data.dump
```

---

## 9. セキュリティ

### 9.1 Row Level Security (RLS)

```sql
-- RLS有効化
ALTER TABLE projects ENABLE ROW LEVEL SECURITY;
ALTER TABLE headlines ENABLE ROW LEVEL SECURITY;
ALTER TABLE outlines ENABLE ROW LEVEL SECURITY;
ALTER TABLE contents ENABLE ROW LEVEL SECURITY;

-- ポリシー設定（ユーザーは自分のデータのみアクセス可能）
CREATE POLICY projects_user_policy ON projects
  FOR ALL
  USING (user_id = current_setting('app.current_user_id')::uuid);

CREATE POLICY headlines_user_policy ON headlines
  FOR ALL
  USING (
    project_id IN (
      SELECT id FROM projects WHERE user_id = current_setting('app.current_user_id')::uuid
    )
  );
```

### 9.2 暗号化

**APIキーの暗号化**:
```sql
-- pgcrypto拡張を使用
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 暗号化して保存
INSERT INTO api_keys (user_id, provider, key_encrypted)
VALUES (
  $1,
  $2,
  pgp_sym_encrypt($3, current_setting('app.encryption_key'))
);

-- 復号化して取得
SELECT 
  id,
  user_id,
  provider,
  pgp_sym_decrypt(key_encrypted::bytea, current_setting('app.encryption_key')) AS api_key
FROM api_keys
WHERE user_id = $1 AND provider = $2;
```

---

## 10. 監視・メンテナンス

### 10.1 監視クエリ

**テーブルサイズ**:
```sql
SELECT
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

**インデックス使用状況**:
```sql
SELECT
  schemaname,
  tablename,
  indexname,
  idx_scan,
  idx_tup_read,
  idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan ASC;
```

**スロークエリ**:
```sql
SELECT
  query,
  calls,
  total_time,
  mean_time,
  max_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 20;
```

### 10.2 メンテナンスタスク

**VACUUM**:
```sql
-- 自動VACUUM設定
ALTER TABLE projects SET (autovacuum_vacuum_scale_factor = 0.1);
ALTER TABLE generations SET (autovacuum_vacuum_scale_factor = 0.05);

-- 手動VACUUM
VACUUM ANALYZE projects;
```

**統計情報更新**:
```sql
ANALYZE projects;
ANALYZE generations;
```

---

## 11. サンプルクエリ

### 11.1 よく使うクエリ

**ユーザーのプロジェクト一覧**:
```sql
SELECT
  p.id,
  p.title,
  p.status,
  p.current_step,
  p.word_count,
  p.created_at,
  p.updated_at,
  COUNT(DISTINCT o.id) AS outline_count,
  COUNT(DISTINCT c.id) FILTER (WHERE c.status = 'completed') AS completed_sections
FROM projects p
LEFT JOIN outlines o ON o.project_id = p.id
LEFT JOIN contents c ON c.outline_id = o.id
WHERE p.user_id = $1 AND p.deleted_at IS NULL
GROUP BY p.id
ORDER BY p.updated_at DESC
LIMIT 20 OFFSET $2;
```

**プロジェクトの詳細取得**:
```sql
SELECT
  p.*,
  json_build_object(
    'headlines', (
      SELECT json_agg(h.*)
      FROM headlines h
      WHERE h.project_id = p.id
    ),
    'outlines', (
      SELECT json_agg(
        json_build_object(
          'outline', o.*,
          'content', c.*
        )
      )
      FROM outlines o
      LEFT JOIN contents c ON c.outline_id = o.id
      WHERE o.project_id = p.id
      ORDER BY o.order_index
    )
  ) AS details
FROM projects p
WHERE p.id = $1 AND p.user_id = $2;
```

**ユーザーの使用統計**:
```sql
SELECT
  u.id,
  u.email,
  u.plan,
  COUNT(DISTINCT p.id) AS total_projects,
  COUNT(DISTINCT p.id) FILTER (WHERE p.status = 'completed') AS completed_projects,
  SUM(g.tokens_input + g.tokens_output) AS total_tokens,
  SUM(g.cost) AS total_cost,
  COUNT(g.id) AS total_generations
FROM users u
LEFT JOIN projects p ON p.user_id = u.id AND p.deleted_at IS NULL
LEFT JOIN generations g ON g.user_id = u.id
WHERE u.id = $1
GROUP BY u.id;
```

---

## 12. まとめ

### 12.1 実装フェーズ

| フェーズ | ストレージ | 実装時期 |
|---------|-----------|---------|
| MVP | LocalStorage | Phase 1 |
| ベータ版 | PostgreSQL | Phase 2 |
| 本番版 | PostgreSQL + Redis | Phase 3 |

### 12.2 容量見積もり

**1ユーザーあたりのデータ量**:
- プロジェクト: 約10KB/件
- 見出し: 約1KB/件
- 目次: 約500B/件
- 本文: 約5KB/件
- 生成履歴: 約2KB/件

**10,000ユーザー、平均10プロジェクト/ユーザーの場合**:
- プロジェクト: 10,000 × 10 × 10KB = 1GB
- 合計: 約5GB（インデックス含む）

---

**文書バージョン**: 1.0  
**作成日**: 2025年12月1日  
**最終更新日**: 2025年12月1日  
**次回レビュー**: Phase 2実装開始時


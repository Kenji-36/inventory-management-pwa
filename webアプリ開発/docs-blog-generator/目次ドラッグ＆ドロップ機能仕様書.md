# 目次ドラッグ＆ドロップ機能 仕様書

## 1. データ構造

目次は以下の階層構造を持ちます：

```
目次（TOC）
├── 大見出し（H2レベル）親ノード
│   ├── 中見出し（H3レベル）子ノード
│   ├── 中見出し（H3レベル）子ノード
│   └── 中見出し（H3レベル）子ノード
├── 大見出し（H2レベル）親ノード
│   ├── 中見出し（H3レベル）子ノード
│   └── 中見出し（H3レベル）子ノード
└── 大見出し（H2レベル）親ノード
    └── 中見出し（H3レベル）子ノード
```

- **親ノード（H2）**: 記事の大きなセクションを表す。子ノードを0個以上持つことができる
- **子ノード（H3）**: 親ノードに属する小さなセクション。必ず1つの親ノードに所属する

---

## 2. ドラッグ＆ドロップの基本ルール

### 2.1 ドラッグ可能な要素
- 親ノード（H2）単体
- 子ノード（H3）単体

### 2.2 親ノード（H2）をドラッグした場合の挙動

**重要な原則**: 親ノードをドラッグすると、**その親ノードに属するすべての子ノード（H3）も一緒に移動する**。

```
【移動前】
1. SEOとは？
   ├── 1-1. SEOの定義
   └── 1-2. SEOの重要性
2. キーワード選定
   ├── 2-1. キーワードリサーチ
   └── 2-2. 競合分析
3. コンテンツ最適化

【「1. SEOとは？」を「3. コンテンツ最適化」の後ろにドラッグ】

【移動後】
1. キーワード選定
   ├── 1-1. キーワードリサーチ
   └── 1-2. 競合分析
2. コンテンツ最適化
3. SEOとは？              ← 親ノードが移動
   ├── 3-1. SEOの定義     ← 子ノードも一緒に移動
   └── 3-2. SEOの重要性   ← 子ノードも一緒に移動
```

**ドロップ可能な位置（親ノードの場合）**:
- 他の親ノードの**前**または**後ろ**（同じ階層レベル内での移動）
- 親ノードを子ノードの位置にドロップすることは**禁止**（階層構造の破壊を防ぐ）

---

### 2.3 子ノード（H3）をドラッグした場合の挙動

子ノードは以下の3つの操作が可能です：

#### パターンA: 同じ親の中で順序変更
同じ親ノード内で、子ノードの順番を入れ替える。

```
【移動前】
1. SEOとは？
   ├── 1-1. SEOの定義
   ├── 1-2. SEOの重要性
   └── 1-3. SEOの歴史

【「1-1. SEOの定義」を「1-3. SEOの歴史」の後ろにドラッグ】

【移動後】
1. SEOとは？
   ├── 1-1. SEOの重要性   ← 番号は自動で振り直し
   ├── 1-2. SEOの歴史
   └── 1-3. SEOの定義     ← 移動した項目
```

#### パターンB: 別の親に移動
子ノードを別の親ノードの下に移動する。

```
【移動前】
1. SEOとは？
   ├── 1-1. SEOの定義
   └── 1-2. SEOの重要性
2. キーワード選定
   ├── 2-1. キーワードリサーチ
   └── 2-2. 競合分析

【「1-2. SEOの重要性」を「2. キーワード選定」の子ノードとしてドラッグ】

【移動後】
1. SEOとは？
   └── 1-1. SEOの定義
2. キーワード選定
   ├── 2-1. キーワードリサーチ
   ├── 2-2. 競合分析
   └── 2-3. SEOの重要性   ← 別の親に移動
```

#### パターンC: 子ノードを親ノードに昇格（オプション機能）
子ノードを親ノードの位置にドロップすると、その子ノードは新しい親ノード（H2）に昇格する。

```
【移動前】
1. SEOとは？
   ├── 1-1. SEOの定義
   └── 1-2. SEOの重要性
2. キーワード選定

【「1-2. SEOの重要性」を「1. SEOとは？」と「2. キーワード選定」の間にドラッグ】

【移動後】
1. SEOとは？
   └── 1-1. SEOの定義
2. SEOの重要性           ← 親ノードに昇格（子ノードは持たない）
3. キーワード選定
```

**ドロップ可能な位置（子ノードの場合）**:
- 同じ親ノード内の他の子ノードの**前**または**後ろ**
- 別の親ノードの子ノードの**前**または**後ろ**
- 親ノードの直後（その親の最初の子として挿入）
- 親ノード間（親ノードに昇格、オプション機能）

---

## 3. ドロップゾーンの視覚的表示

ドラッグ中は、ドロップ可能な位置を視覚的に示す必要があります。

### 3.1 ドロップインジケーターの種類

**水平線インジケーター**:
- 要素と要素の間にドロップする場合
- 青い水平線（2px）で挿入位置を表示

```
1. SEOとは？
   ├── 1-1. SEOの定義
   ────────────────────  ← 青い線（ここにドロップ可能）
   └── 1-2. SEOの重要性
```

**ハイライトインジケーター**:
- 親ノードの子として追加する場合
- 親ノード全体を薄い青色でハイライト

```
┌─────────────────────────┐
│ 2. キーワード選定       │ ← 薄い青色ハイライト
│   ├── 2-1. ...         │   （この親の子として追加）
│   └── 2-2. ...         │
└─────────────────────────┘
```

### 3.2 ドロップ禁止の表示

無効なドロップ位置にカーソルがある場合：
- カーソルを「禁止」アイコン（🚫）に変更
- ドラッグ中の要素を赤くハイライト
- ドロップしても何も起こらない

**禁止される操作**:
- 親ノードを子ノードの位置にドロップ（階層の逆転）
- 自分自身の子孫の位置にドロップ（循環参照の防止）
- 自分自身の直前または直後にドロップ（意味のない操作）

---

## 4. ドラッグ中の視覚的フィードバック

### 4.1 ドラッグ中の要素

```
┌─────────────────────────┐
│ ≡ 1. SEOとは？          │ ← 半透明（opacity: 0.5）
│   ├── 1-1. SEOの定義    │   影付き（box-shadow）
│   └── 1-2. SEOの重要性  │   カーソルに追従
└─────────────────────────┘
```

- 不透明度を50%に設定
- ドロップシャドウを追加
- カーソルを「掴んでいる」アイコンに変更
- 親ノードをドラッグ中は子ノードも一緒に半透明表示

### 4.2 元の位置のプレースホルダー

ドラッグ開始位置には、点線の枠でプレースホルダーを表示：

```
┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
  1. SEOとは？            ← 点線枠（元の位置を示す）
    ├── 1-1. SEOの定義
    └── 1-2. SEOの重要性
└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘
```

---

## 5. 番号の自動振り直し

ドロップ完了後、以下の番号を自動的に振り直します：

### 5.1 親ノードの番号
- 1, 2, 3... と連番で振り直し

### 5.2 子ノードの番号
- 親番号-子番号 の形式（例: 1-1, 1-2, 2-1, 2-2）
- 親が変わった場合も自動で振り直し

```
【移動前】
1. SEOとは？
   └── 1-1. SEOの定義
2. キーワード選定
   ├── 2-1. キーワードリサーチ
   └── 2-2. 競合分析

【「2. キーワード選定」を「1. SEOとは？」の前に移動】

【移動後（番号自動振り直し）】
1. キーワード選定          ← 旧2 → 新1
   ├── 1-1. キーワードリサーチ  ← 旧2-1 → 新1-1
   └── 1-2. 競合分析       ← 旧2-2 → 新1-2
2. SEOとは？               ← 旧1 → 新2
   └── 2-1. SEOの定義      ← 旧1-1 → 新2-1
```

---

## 6. 操作の確定とキャンセル

### 6.1 ドロップで確定
- 有効なドロップゾーンでマウスを離すと、移動が確定
- 即座にUIに反映され、番号が振り直される

### 6.2 キャンセル方法
- **Escキー**: ドラッグ中にEscキーを押すとキャンセル
- **元の位置にドロップ**: 変更なし
- **無効な位置でドロップ**: 元の位置に戻る

### 6.3 元に戻す（Undo）
- Ctrl+Z（Cmd+Z）で直前の移動を取り消し可能
- 複数回のUndoに対応（履歴を保持）

---

## 7. アクセシビリティ対応

### 7.1 キーボード操作
- **Tab**: 目次項目間を移動
- **Space/Enter**: 選択した項目のドラッグモードを開始
- **矢印キー**: ドラッグモード中に移動先を選択
- **Space/Enter**: ドロップを確定
- **Escape**: ドラッグをキャンセル

### 7.2 スクリーンリーダー対応
- ドラッグ開始時: 「[項目名]を移動中。矢印キーで移動先を選択してください」
- 移動先変更時: 「[親ノード名]の[位置]に移動します」
- ドロップ確定時: 「[項目名]を[新しい位置]に移動しました」

---

## 8. エッジケースの処理

### 8.1 空の親ノード
子ノードをすべて移動した場合、親ノードは子を持たない状態で残る（削除はしない）。

```
1. SEOとは？
   （子ノードなし）  ← 空の状態で表示
2. キーワード選定
   ├── 2-1. SEOの定義     ← 移動してきた子ノード
   ├── 2-2. キーワードリサーチ
   └── 2-3. 競合分析
```

### 8.2 最大階層の制限
- 階層は2レベルまで（H2とH3のみ）
- H3をさらにネストしてH4にすることは禁止
- 子ノードの下に子ノードをドロップしようとした場合、同じ親の末尾に追加

### 8.3 最小項目数
- 親ノード（H2）は最低1つ必要
- 子ノード（H3）は0個でも可
- 最後の親ノードを削除しようとした場合、警告を表示

---

## 9. データ更新の流れ

```
1. ドラッグ開始
   ↓
2. ドラッグ中（ドロップ位置のプレビュー表示）
   ↓
3. ドロップ実行
   ↓
4. バリデーション（有効な移動かチェック）
   ↓
5. データ構造の更新
   ↓
6. 番号の振り直し
   ↓
7. UIの再レンダリング
   ↓
8. ローカルストレージへの自動保存
```

---

## 10. 実装時の推奨ライブラリ

- **React**: `@dnd-kit/core`, `@dnd-kit/sortable`（推奨）
- **Vue**: `vue-draggable-next`
- **Vanilla JS**: `SortableJS`

これらのライブラリは階層構造のドラッグ＆ドロップに対応しており、親子関係を維持した移動を実装できます。

---

## 11. 技術的な実装ポイント

### 11.1 データモデル（TypeScript例）

```typescript
interface TocItem {
  id: string;           // ユニークID
  title: string;        // 見出しテキスト
  level: 'h2' | 'h3';   // 階層レベル
  parentId: string | null; // 親のID（H2の場合はnull）
  order: number;        // 同一階層内での順序
}

interface TocState {
  items: TocItem[];
  history: TocItem[][];  // Undo用の履歴
}
```

### 11.2 移動時のバリデーション関数

```typescript
function canDrop(
  draggedItem: TocItem,
  targetPosition: DropPosition
): boolean {
  // 1. 自分自身への移動は禁止
  if (draggedItem.id === targetPosition.targetId) return false;
  
  // 2. H2をH3の位置にドロップは禁止
  if (draggedItem.level === 'h2' && targetPosition.asChild) return false;
  
  // 3. 自分の子孫への移動は禁止（循環参照防止）
  if (isDescendant(draggedItem.id, targetPosition.targetId)) return false;
  
  return true;
}
```

---

**文書バージョン**: 1.0  
**作成日**: 2025年12月9日  
**関連ドキュメント**: 機能要件書.md, 画面設計書.md

